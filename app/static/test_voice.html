<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grok Voice Live 测试</title>
    <script src="https://cdn.jsdelivr.net/npm/livekit-client@2.7.3/dist/livekit-client.umd.min.js"
        onerror="log('LiveKit SDK Script failed to load')" onload="log('LiveKit SDK Script loaded')"></script>
    <style>
        :root {
            --primary-color: #007AFF;
            --bg-color: #1c1c1e;
            --card-bg: #2c2c2e;
            --text-color: #ffffff;
            --success-color: #34c759;
            --error-color: #ff3b30;
            --input-bg: #1c1c1e;
            --input-border: #444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }

        .container {
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
            width: 90%;
            max-width: 450px;
        }

        h1 {
            margin-bottom: 1.5rem;
            font-weight: 600;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            background-color: #666;
        }

        .status-connected {
            background-color: var(--success-color);
            box-shadow: 0 0 10px var(--success-color);
        }

        .status-connecting {
            background-color: #ffcc00;
        }

        .status-error {
            background-color: var(--error-color);
        }

        .controls {
            margin-top: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            text-align: left;
        }

        .form-group label {
            font-size: 0.85rem;
            color: #aaa;
            margin-left: 2px;
        }

        select,
        input {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--input-border);
            background: var(--input-bg);
            color: white;
            font-size: 0.95rem;
            outline: none;
        }

        button {
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 0.5rem;
        }

        #startBtn {
            background-color: var(--primary-color);
            color: white;
        }

        #startBtn:disabled {
            background-color: #3a3a3c;
            color: #8e8e93;
            cursor: not-allowed;
        }

        #stopBtn {
            background-color: transparent;
            color: var(--error-color);
            border: 1px solid var(--error-color);
        }

        .hidden {
            display: none;
        }

        #log {
            margin-top: 1.5rem;
            text-align: left;
            font-size: 0.85rem;
            color: #8e8e93;
            max-height: 150px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 8px;
        }

        .visualizer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            height: 40px;
            margin-top: 1rem;
        }

        .bar {
            width: 4px;
            height: 4px;
            background-color: var(--primary-color);
            border-radius: 2px;
            transition: height 0.1s;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Grok Voice Live</h1>
        <div>
            <span id="statusIcon" class="status-indicator"></span>
            <span id="statusText">未连接</span>
        </div>

        <div class="visualizer" id="visualizer">
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
        </div>

        <div class="controls">
            <div class="form-group">
                <label for="apiKey">API Key (可选)</label>
                <input id="apiKey" placeholder="输入 API Key">
            </div>

            <div class="form-group">
                <label for="voiceSelect">声音 (Voice)</label>
                <select id="voiceSelect">
                    <option value="ara" selected>Ara (Upbeat Female)</option>
                    <option value="eve">Eve (Soothing Female)</option>
                    <option value="leo">Leo (British Male)</option>
                    <option value="rex">Rex (Calm Male)</option>
                    <option value="sal">Sal (Smooth Male)</option>
                    <option value="gork">Gork (Lazy Male)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="personalitySelect">个性 (Personality)</label>
                <select id="personalitySelect">
                    <option value="assistant" selected>Assistant (Default)</option>
                    <option value="custom">Custom</option>
                    <option value="therapist">Therapist</option>
                    <option value="storyteller">Storyteller</option>
                    <option value="kids_story_time">Kids Story Time</option>
                    <option value="kids_trivia_game">Kids Trivia Game</option>
                    <option value="meditation">Meditation</option>
                    <option value="doc">Grok "Doc"</option>
                    <option value="unhinged">Unhinged 18+</option>
                    <option value="sexy">Sexy 18+</option>
                    <option value="motivation">Motivation 18+</option>
                    <option value="conspiracy">Conspiracy</option>
                    <option value="romantic">Romantic 18+</option>
                    <option value="argumentative">Argumentative 18+</option>
                </select>
            </div>

            <div class="form-group">
                <label for="speedRange">语速: <span id="speedValue">1.0</span>x</label>
                <input type="range" id="speedRange" min="0.5" max="2.0" step="0.1" value="1.0">
            </div>

            <button id="startBtn">开始语音对话</button>
            <button id="stopBtn" class="hidden">停止对话</button>
        </div>

        <div id="log"></div>
    </div>

    <script>
        // Use a more reliable way to wait for the SDK to load
        let Room, createLocalTracks, RoomEvent, Track;

        function initLiveKit() {
            // Check both possible global variable names
            const lk = window.LiveKitClient || window.LivekitClient;
            if (!lk) {
                const keys = Object.keys(window).filter(k => k.toLowerCase().includes('live'));
                console.error('LiveKit SDK not found. Available window keys:', keys);
                log('调试信息: 无法找到 LiveKitClient. Window 中包含 "live" 的属性: ' + JSON.stringify(keys));
                return false;
            }
            Room = lk.Room;
            createLocalTracks = lk.createLocalTracks;
            RoomEvent = lk.RoomEvent;
            Track = lk.Track;
            return true;
        }

        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusIcon = document.getElementById('statusIcon');
        const statusText = document.getElementById('statusText');
        const logContainer = document.getElementById('log');
        const apiKeyInput = document.getElementById('apiKey');

        const voiceSelect = document.getElementById('voiceSelect');
        const personalitySelect = document.getElementById('personalitySelect');
        const speedRange = document.getElementById('speedRange');
        const speedValue = document.getElementById('speedValue');

        // Update speed label
        speedRange.addEventListener('input', (e) => {
            speedValue.textContent = e.target.value;
        });

        let room;

        function log(msg) {
            const p = document.createElement('p');
            p.style.margin = '4px 0';
            p.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logContainer.prepend(p);
            console.log(msg);
        }

        async function startSession() {
            if (!Room && !initLiveKit()) {
                log('错误: LiveKit SDK 未能正确加载，请刷新页面重试');
                return;
            }
            try {
                startBtn.disabled = true;
                log('正在获取 Token...');
                statusText.textContent = '正在连接...';
                statusIcon.className = 'status-indicator status-connecting';

                const apiKey = apiKeyInput.value;
                const voice = voiceSelect.value;
                const personality = personalitySelect.value;
                const speed = speedRange.value;

                // Build query params
                const params = new URLSearchParams({
                    voice: voice,
                    personality: personality,
                    speed: speed
                });

                const response = await fetch(`/v1/voice/token?${params.toString()}`, {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`获取 Token 失败: ${response.status}`);
                }

                const { token, url } = await response.json();
                log(`获取 Token 成功 (${voice}, ${personality}, ${speed}x)`);

                room = new Room({
                    adaptiveStream: true,
                    dynacast: true,
                });

                room.on(RoomEvent.ParticipantConnected, (p) => log(`参与者已连接: ${p.identity}`));
                room.on(RoomEvent.ParticipantDisconnected, (p) => log(`参与者已断开: ${p.identity}`));
                room.on(RoomEvent.TrackSubscribed, (track) => {
                    log(`订阅音轨: ${track.kind}`);
                    if (track.kind === 'audio') {
                        const element = track.attach();
                        document.body.appendChild(element);
                    }
                });

                room.on(RoomEvent.Disconnected, () => {
                    log('已断开连接');
                    resetUI();
                });

                await room.connect(url, token);
                log('已连接到 LiveKit 服务器');

                statusText.textContent = '通话中';
                statusIcon.className = 'status-indicator status-connected';
                startBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');

                log('正在开启麦克风...');
                const tracks = await createLocalTracks({ audio: true, video: false });
                for (const track of tracks) {
                    await room.localParticipant.publishTrack(track);
                }
                log('语音已开启');

            } catch (err) {
                log(`错误: ${err.message}`);
                console.error(err);
                statusText.textContent = '连接错误';
                statusIcon.className = 'status-indicator status-error';
                startBtn.disabled = false;
            }
        }

        async function stopSession() {
            if (room) {
                await room.disconnect();
            }
            resetUI();
        }

        function resetUI() {
            statusText.textContent = '未连接';
            statusIcon.className = 'status-indicator';
            startBtn.classList.remove('hidden');
            stopBtn.classList.add('hidden');
            startBtn.disabled = false;
        }

        startBtn.addEventListener('click', startSession);
        stopBtn.addEventListener('click', stopSession);

        // 简易动画效果
        setInterval(() => {
            if (statusIcon.classList.contains('status-connected')) {
                document.querySelectorAll('.bar').forEach(bar => {
                    bar.style.height = `${Math.random() * 30 + 5}px`;
                });
            } else {
                document.querySelectorAll('.bar').forEach(bar => {
                    bar.style.height = `4px`;
                });
            }
        }, 150);
    </script>
</body>

</html>